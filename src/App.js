import React, { useState, useEffect } from 'react';
import './App.css';

interface WeatherData {
  city: string;
  temp: number;
  description: string;
  humidity: number;
}

interface UserData {
  cep: string;
  weather?: WeatherData;
  scores: { [key: string]: number };
  currentQuestion: number;
  totalQuestions: number;
}

const App: React.FC = () => {
  const [currentScreen, setCurrentScreen] = useState<string>('welcome');
  const [userData, setUserData] = useState<UserData>({
    cep: '',
    scores: {},
    currentQuestion: 1,
    totalQuestions: 39
  });

  const [weatherLoading, setWeatherLoading] = useState<boolean>(false);

  // API de Clima via CEP (simulada por enquanto)
  const fetchWeatherByCep = async (cep: string) => {
    if (!cep || cep.length !== 8) return;
    
    setWeatherLoading(true);
    try {
      // Simula√ß√£o de API - substituir por APIs reais depois
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      const weather: WeatherData = {
        city: `S√£o Paulo, SP`, // Simular baseado no CEP
        temp: Math.round(Math.random() * 15 + 15), // 15-30¬∞C
        description: 'Parcialmente nublado',
        humidity: Math.round(Math.random() * 30 + 50) // 50-80%
      };
      
      setUserData(prev => ({ ...prev, weather }));
    } catch (error) {
      console.error('Erro ao buscar clima:', error);
    }
    setWeatherLoading(false);
  };

  // Quest√µes do formul√°rio (vers√£o simplificada para demonstra√ß√£o)
  const questions = [
    { id: 'q1', category: 'corporal', title: 'Hidrata√ß√£o Consciente', description: 'Manter hidrata√ß√£o constante ao longo do dia com √°gua pura e fresca' },
    { id: 'q2', category: 'corporal', title: 'Timing Nutricional', description: 'Consumir frutas com o est√¥mago vazio ou antes das refei√ß√µes' },
    { id: 'q3', category: 'mental', title: 'Alimenta√ß√£o Consciente', description: 'Mastigar devagar e saborear cada alimento' },
    { id: 'q4', category: 'emocional', title: 'Equil√≠brio Emocional', description: 'N√£o comer por ansiedade ou estresse' },
    { id: 'q5', category: 'social', title: 'Refei√ß√µes Sociais', description: 'Compartilhar refei√ß√µes em fam√≠lia ou amigos' }
  ];

  const handleSliderChange = (questionId: string, value: number) => {
    setUserData(prev => ({
      ...prev,
      scores: { ...prev.scores, [questionId]: value }
    }));
  };

  const calculateResults = () => {
    const categories = ['corporal', 'mental', 'emocional', 'social', 'espiritual'];
    
    const results = categories.map(category => {
      const categoryQuestions = questions.filter(q => q.category === category);
      const totalScore = categoryQuestions.reduce((sum, q) => sum + (userData.scores[q.id] || 50), 0);
      const average = categoryQuestions.length > 0 ? totalScore / categoryQuestions.length : 50;
      
      return {
        category,
        score: Math.round(average),
        level: getScoreLevel(average)
      };
    });

    return results;
  };

  const getScoreLevel = (score: number) => {
    if (score < 20) return { label: 'Aten√ß√£o', color: 'red' };
    if (score < 40) return { label: 'Desenvolvimento', color: 'orange' };
    if (score < 60) return { label: 'Crescimento', color: 'yellow' };
    if (score < 80) return { label: 'Consolida√ß√£o', color: 'blue' };
    return { label: 'Excel√™ncia', color: 'green' };
  };

  const getWeatherNutritionTip = (weather?: WeatherData) => {
    if (!weather) return '';
    
    if (weather.temp > 25) {
      return 'üå°Ô∏è Clima quente: Priorize hidrata√ß√£o e alimentos refrescantes como melancia, pepino e √°gua de coco!';
    } else if (weather.temp < 18) {
      return '‚ùÑÔ∏è Clima frio: Ideal para sopas nutritivas, ch√°s quentes e alimentos termog√™nicos como gengibre!';
    } else {
      return 'üå§Ô∏è Clima agrad√°vel: Perfeito para refei√ß√µes balanceadas ao ar livre e atividade f√≠sica!';
    }
  };

  return (
    <div className="app-container">
      {/* Badge 1 M√äS GR√ÅTIS */}
      <div className="test-badge">
        ‚ú® TESTE GR√ÅTIS - 1 M√äS COMPLETO
      </div>

      {currentScreen === 'welcome' && (
        <div className="welcome-screen fade-in">
          <div className="section-card">
            <div className="text-center">
              <div className="welcome-emoji">üåü</div>
              
              <h2 className="trial-badge">TESTE GR√ÅTIS</h2>
              <p className="trial-period">Prazo de validade: 1 m√™s completo</p>
              
              <h1 className="app-title">JORNADA DA NUTRI√á√ÉO INTEGRAL</h1>
              
              <div className="doctor-card">
                <h3>Dr Olair Rafael da Silva J√∫nior</h3>
                <p>M√©dico Especialista (RQE CRM-SP) em Pediatria e Medicina do Trabalho<br/>
                   P√≥s-graduado em Homeopatia, Nutrologia, Medicina Can√°bica,<br/>
                   Medicina do Estilo de Vida e Longevidade Saud√°vel</p>
              </div>

              {/* CEP Input para Clima */}
              <div className="weather-section">
                <h4>üå§Ô∏è Recomenda√ß√µes baseadas no seu clima local</h4>
                <div className="cep-input-group">
                  <input
                    type="text"
                    placeholder="Digite seu CEP (ex: 01234567)"
                    value={userData.cep}
                    onChange={(e) => setUserData(prev => ({ ...prev, cep: e.target.value.replace(/\D/g, '') }))}
                    maxLength={8}
                    className="cep-input"
                  />
                  <button 
                    onClick={() => fetchWeatherByCep(userData.cep)}
                    disabled={weatherLoading || userData.cep.length !== 8}
                    className="weather-btn"
                  >
                    {weatherLoading ? '‚è≥' : 'üîç'}
                  </button>
                </div>
                
                {userData.weather && (
                  <div className="weather-card">
                    <p><strong>{userData.weather.city}</strong></p>
                    <p>{userData.weather.temp}¬∞C - {userData.weather.description}</p>
                    <p className="weather-tip">{getWeatherNutritionTip(userData.weather)}</p>
                  </div>
                )}
              </div>
              
              <div className="welcome-text">
                <p>Aceita as minhas Boas-Vindas!</p>
                <p>Comece agora os seus primeiros passos na sua <strong><em>Evolu√ß√£o Consciente</em></strong> para um modo Alegre e Feliz de bem-viver!</p>
              </div>
              
              <div className="action-buttons">
                <button 
                  onClick={() => setCurrentScreen('assessment')}
                  className="primary-btn"
                >
                  <em>Vamos iniciar com a sua <strong>AUTOAVALIA√á√ÉO NUTRICIONAL</strong></em>
                </button>
                
                <button 
                  onClick={() => setCurrentScreen('about')}
                  className="secondary-btn"
                >
                  üìñ Sobre o M√©todo
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {currentScreen === 'assessment' && (
        <div className="assessment-screen fade-in">
          <div className="section-card">
            <h1>üìä Autoavalia√ß√£o dos Cinco Corpos</h1>
            <p>Avalie seu grau de compromisso com a nutri√ß√£o f√≠sica e sutil</p>
            
            {/* Progress Bar */}
            <div className="progress-container">
              <div className="progress-bar">
                <div 
                  className="progress-fill" 
                  style={{ width: `${(Object.keys(userData.scores).length / questions.length) * 100}%` }}
                />
              </div>
              <p>Conclu√≠das: {Object.keys(userData.scores).length} de {questions.length}</p>
            </div>

            {/* Quest√µes */}
            {questions.map((question, index) => (
              <div key={question.id} className="questao-card">
                <h3>{String(index + 1).padStart(2, '0')}. {question.title}</h3>
                <p>{question.description}</p>
                <div className="slider-container">
                  <input
                    type="range"
                    className="slider"
                    min="0"
                    max="99"
                    value={userData.scores[question.id] || 50}
                    onChange={(e) => handleSliderChange(question.id, parseInt(e.target.value))}
                  />
                  <div className="valor-display">
                    {userData.scores[question.id] || 50}
                  </div>
                </div>
              </div>
            ))}

            <div className="assessment-actions">
              <button 
                onClick={() => setCurrentScreen('results')}
                className="primary-btn"
              >
                üìà Ver Meu Plano Personalizado
              </button>
            </div>
          </div>
        </div>
      )}

      {currentScreen === 'results' && (
        <div className="results-screen fade-in">
          <div className="section-card">
            <h1>üéØ Seu Plano Personalizado</h1>
            
            {userData.weather && (
              <div className="weather-recommendation">
                <h3>üå§Ô∏è Recomenda√ß√£o baseada no clima de {userData.weather.city}</h3>
                <p>{getWeatherNutritionTip(userData.weather)}</p>
              </div>
            )}

            <div className="results-grid">
              {calculateResults().map((result) => (
                <div key={result.category} className="resultado-card">
                  <h3>{result.category.toUpperCase()}</h3>
                  <div className="score-display">{result.score}</div>
                  <p className={`level-${result.level.color}`}>{result.level.label}</p>
                </div>
              ))}
            </div>

            <div className="subscription-section">
              <h2>üéä Parab√©ns! Voc√™ completou a avalia√ß√£o!</h2>
              <p>Continue sua jornada com acesso completo por apenas:</p>
              
              <div className="pricing-card">
                <div className="price">R$ 97,00/m√™s</div>
                <div className="trial-info">‚ú® Primeiro m√™s GR√ÅTIS!</div>
                
                <button 
                  onClick={() => setCurrentScreen('payment')}
                  className="subscribe-btn"
                >
                  üöÄ Continuar Jornada - PIX Instant√¢neo
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {currentScreen === 'payment' && (
        <div className="payment-screen fade-in">
          <div className="section-card">
            <h1>üí≥ Finalizar Assinatura</h1>
            
            <div className="payment-summary">
              <h3>üìã Resumo do Pedido</h3>
              <div className="plan-details">
                <p><strong>Plano:</strong> Jornada da Nutri√ß√£o Integral</p>
                <p><strong>Primeiro m√™s:</strong> <span className="free">GR√ÅTIS</span></p>
                <p><strong>A partir do 2¬∫ m√™s:</strong> R$ 97,00</p>
              </div>
            </div>

            <div className="pix-section">
              <h3>üì± Pagamento via PIX</h3>
              <div className="qr-code-placeholder">
                <div className="qr-code">
                  [QR CODE AQUI]
                </div>
                <p>Escaneie o c√≥digo ou use a chave PIX:</p>
                <div className="pix-key">pix@jornadadanutricao.com.br</div>
              </div>
              
              <button className="confirm-payment-btn">
                ‚úÖ Confirmar Pagamento
              </button>
            </div>

            <button 
              onClick={() => setCurrentScreen('welcome')}
              className="secondary-btn"
              style={{marginTop: '2rem'}}
            >
              ‚Üê Voltar ao In√≠cio
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;